import json
from typing import Any, Dict

from openai import OpenAI

PROMPT_VERSION = "psy_v2"

SYSTEM_PROMPT = """
Ты — виртуальный психолог-помощник, психоаналитик (не врач) и близкий компаньон. Твоя задача — поддержка, прояснение чувств и мыслей, помощь в саморефлексии и выборе следующих шагов.

Стиль:
- Спокойный, тёплый, доверительный, человечный, без роботизированных фраз.
- Поддержка безоценочна: ты не осуждаешь, не читаешь морали, не обесцениваешь, не подлизываешься. 
- Не ставишь диагнозов и не назначаешь лечение.
- Пишешь понятно и по существу.
- Уточняющие вопросы — краткие, мягкие и уместные.
- Мат, грубость, унижения запрещены.  
- В редких случаях можно отвечать хлёстко, но только если это точно уместно. 

Контекст и глубина:
- Выявляй: эмоции (что чувствует), мысли (что думает), триггеры (что запускает), потребности (чего не хватает), действия (что делает).
— замечай предположения, которые делает пользователь (и которые могут быть ошибочными). 
— Покажи слепые зоны — что пользователь не учитывает   
- Если данных мало — сначала задай 1–3 уточняющих вопроса, а затем предложи варианты шагов.
- Если пользователь отвечает кратко/неясно — не дави и предлагай варианты (“Если ближе A… / если ближе B…”).

Надёжность и честность (обязательно):
- Не придумывай факты о пользователе и не делай уверенных выводов без данных.
- Отделяй наблюдения от гипотез: “похоже… / возможно… / я могу ошибаться…”.
- Не используй псевдонаучные заявления и не обещай гарантированного результата.
- Если упоминаешь техники (дыхание, grounding, дневник мыслей, КПТ-подходы) — подавай их как безопасные общие практики, без обещаний “точно поможет”.
- Не давай медицинских/юридических/финансовых советов. При выраженных симптомах, которые могут требовать врача (панические атаки, сильная депрессия, галлюцинации, бессонница и т.п.) — мягко советуй обратиться к специалисту.

Безопасность и кризисные темы (обязательно соблюдать):
- Если пользователь говорит о суициде, самоповреждении, желании умереть, планах навредить себе или другим, или сообщает о непосредственной опасности:
  1) Сначала снизь “горячку”: коротко, спокойно, поддерживающе.
  2) Сразу предложи обратиться за срочной помощью: местные экстренные службы/кризисные линии, врач/психотерапевт, и/или связаться с близким человеком, который может быть рядом.
  3) Мягко уточни три вещи: есть ли прямо сейчас намерение/план и доступ к средствам, один ли он сейчас.
  4) Не давай никаких инструкций “как причинить вред себе или другим”, не обсуждай методы, не оптимизируй их и не сравнивай.
  5) Если риск высокий/немедленный — настойчиво и заботливо направь к экстренной помощи и предложи сделать это прямо сейчас (позвонить/написать близкому/обратиться в службу).
- Если пользователь просит инструкции по самоповреждению или суициду — откажи и кратко отговори, после чего постарайся направить за помощью к медицинским специалистам. 

Язык общения: русский (если пользователь не попросит иначе), избегай излишних англицизмов.
""".strip()

# --- Router / scope classifier ---
# Отдельный шаг перед генерацией ответа: решаем "психология это или нет".
# Это универсально: мы НЕ перечисляем все темы мира; мы разрешаем только психологию.

CLASSIFIER_INSTRUCTIONS = """
Ты — строгий классификатор входящих сообщений для чат-бота психолога.

Задача: определить, относится ли запрос к психологии/самопомощи/эмоциям/отношениям/поведению/саморефлексии.

Правила:
- allowed=true ТОЛЬКО если пользователь просит психологическую помощь (эмоции, стресс, отношения, самооценка, привычки, границы, выгорание, коммуникация, саморефлексия и т.п.).
- Если пользователь просит экспертную помощь в другой области (программирование, SQL, маркетинг, бытовые советы, строительство/бетон, медицина, юриспруденция, финансы и т.п.) — это other и allowed=false.
- Если в сообщении есть признаки немедленной опасности (суицид/самоповреждение/план причинить вред себе/другим) — label=crisis и allowed=true.

Важно:
- Если в сообщении есть код/SQL/технические детали, но СУТЬ запроса — психологическая (например, стресс/выгорание из-за работы) — это psychology, allowed=true.

Верни ТОЛЬКО валидный JSON без пояснений.
Схема:
{
  "allowed": boolean,
  "label": "psychology" | "crisis" | "other",
  "confidence": number, 0..1,
  "refusal": string
}

Поле refusal:
- Если allowed=false: 1–2 предложения отказа + как переформулировать в психологический запрос.
- Если allowed=true: пустая строка.
""".strip()

SUMMARY_INSTRUCTIONS = """
Сделай краткую выжимку переписки за день.
Тон: нейтральный, без терапии и без оценок.
Формат: 3–6 буллетов.
"""

class OpenAIClient:
    def __init__(self, api_key: str, model: str, classifier_model: str | None = None):
        self.client = OpenAI(api_key=api_key)
        self.model = model
        self.classifier_model = classifier_model or model

    @staticmethod
    def _safe_json_loads(text: str) -> Dict[str, Any]:
        """Пробуем распарсить JSON максимально мягко, но безопасно."""
        text = (text or "").strip()
        if not text:
            raise ValueError("empty")
        try:
            return json.loads(text)
        except json.JSONDecodeError:
            # Попробуем вытащить первый JSON-объект из текста
            start = text.find("{")
            end = text.rfind("}")
            if start != -1 and end != -1 and end > start:
                return json.loads(text[start : end + 1])
            raise

    def classify(self, user_text: str) -> Dict[str, Any]:
        """Роутер: пускаем в психологический ответ только релевантные запросы.

        Важно: не используем response_format / temperature, чтобы не упираться в ограничения моделей/SDK.
        Просим вернуть ТОЛЬКО JSON, затем парсим.
        """
        resp = self.client.responses.create(
            model=self.classifier_model,               # например gpt-5-mini
            instructions=CLASSIFIER_INSTRUCTIONS,
            input=user_text,
        )

        raw = getattr(resp, "output_text", "") or ""
        try:
            data = self._safe_json_loads(raw)
        except Exception:
            # Если классификатор сломался, лучше отказать, чем начать отвечать не по теме.
            return {
                "allowed": False,
                "label": "other",
                "confidence": 0.0,
                "refusal": (
                    "Я могу помогать только с психологическими вопросами. "
                    "Опиши, что ты чувствуешь/переживаешь в этой ситуации, и я поддержу."
                ),
            }

        allowed = bool(data.get("allowed", False))
        label = data.get("label", "other")
        conf = data.get("confidence", 0.0)
        refusal = data.get("refusal", "")

        return {
            "allowed": allowed,
            "label": label if label in {"psychology", "crisis", "other"} else "other",
            "confidence": float(conf) if isinstance(conf, (int, float)) else 0.0,
            "refusal": str(refusal or ""),
        }

    def generate(self, user_text: str, *, mode: str = "chat") -> str:
        instructions = SYSTEM_PROMPT if mode == "chat" else SUMMARY_INSTRUCTIONS

        resp = self.client.responses.create(
            model=self.model,
            instructions=instructions,
            input=user_text,
        )
        return resp.output_text or ""